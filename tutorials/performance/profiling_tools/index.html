
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../lookup_tables/">
      
      
        <link rel="next" href="../multiprocessing/">
      
      
      <link rel="icon" href="../../../assets/python.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.44">
    
    
      
        <title>Profiling Tools & Strategy - Best Python Practices</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="yello">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#profiling-tools-strategy" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Best Python Practices" class="md-header__button md-logo" aria-label="Best Python Practices" data-md-component="logo">
      
  <img src="../../../assets/python.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Best Python Practices
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Profiling Tools & Strategy
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="yello"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/felixgao/python-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    best-python-practices
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Best Python Practices" class="md-nav__button md-logo" aria-label="Best Python Practices" data-md-component="logo">
      
  <img src="../../../assets/python.svg" alt="logo">

    </a>
    Best Python Practices
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/felixgao/python-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    best-python-practices
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design_patterns/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Design Patterns
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" checked>
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Performance
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Performance
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lookup_tables/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lookup Tables
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Profiling Tools & Strategy
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multiprocessing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multi-Processing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Packaging
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            Packaging
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packaging/structure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Structure
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packaging/makefile/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Makefile
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packaging/logging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Logging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packaging/code_style/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Code Style
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packaging/api_design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Design
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packaging/anti_patterns/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Anti Patterns
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packaging/testing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Testing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../libraries/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Libraries & Tools
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../pullrequests/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pull Requests Etiquette
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p><img alt="✅" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/2705.svg" title=":white_check_mark:" /> Use the standard python <a href="https://docs.python.org/3/library/profile.html#profile">cProfile</a> profiler</p>
<p><img alt="✅" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/2705.svg" title=":white_check_mark:" /> Use PyCharm (Professional Edition) <code>.pstat</code> profile viewer</p>
<p><img alt="✅" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/2705.svg" title=":white_check_mark:" /> Ensure entire program can be easily tested for performance</p>
</div>
<h1 id="profiling-tools-strategy">Profiling Tools &amp; Strategy<a class="headerlink" href="#profiling-tools-strategy" title="Permanent link">&para;</a></h1>
<p>Profiling code is a hugely important part of data science code since machine
learning and AI algorithms are typically compute heavy processes. Performance
tuning is relevant during both training and prediction time.</p>
<p>During training time, performant code allows developers to have shorter 
development/training cycles. The difference between a function call that takes
10 seconds vs 1 second has a huge impact on the development experience. An 
example that many people have likely run into is when loading huge word vector 
models into memory. A load of GoogleNews W2V using Gensim can take multiple 
minutes before even being able to do a computation.</p>
<p>During prediction time, performance typically dictates how much a model will
cost to host. Performance is often ignored in favor of scaling out horizontally
and just paying the cost of hosting. Besides saving on hosting costs, the 
biggest motivating factor for performance tuning code would be the ability to
have a better/faster development experience (just like during training).</p>
<h1 id="tools">Tools<a class="headerlink" href="#tools" title="Permanent link">&para;</a></h1>
<p>There are a variety of profiling tools for python which fall under two 
different categories:</p>
<ul>
<li>
<p><strong>Scope-Based Profilers</strong>: These profilers generally use the built-in 
    <a href="https://docs.python.org/3/library/sys.html#sys.setprofile">sys.setprofile</a> or <a href="https://docs.python.org/3/library/sys.html#sys.settrace">sys.settrace</a> python library calls to track the 
    duration of each stack frame. Every time a function enters a scope, a start
    time is recorded, and every time the function exits, the end time is 
    recorded. This allows the profiler to record a hierarchical view of where 
    time is spent. These types of profilers may also introduce a lot of 
    overhead since every single scope entrance/exit is tracked. For programs
    which have many function calls (such as mapping a function over a giant 
    collection) the overhead of a scope-based profiler may give inflated
    measurements. Another limitation is that many python functions do not 
    generate a stack frame (for example built-in functions). This means that
    scope-based trackers may not give a granular enough idea of where
    time is being spent. Scope-based profilers cannot give line-level profiling
    information.</p>
</li>
<li>
<p><strong>Sampling Profilers</strong>: These profilers generally use the built-in 
    <a href="https://docs.python.org/3/library/sys.html#sys._getframe">sys._getframe</a> python library call to get the current state of the 
    application. In contrast to a scoped-based profiler, sampling profilers only
    periodically query the running python application to determine where time is
    being spent. Rather than tracking the duration of a function scope, a 
    sampling profiler tracks the number of times it sees a specific stack frame.
    This means that a sampling profiler will not track a very accurate measure
    of the overall method time. A huge benefit of a sampling profiler is that
    it has the ability to give line-level profile information. It also has 
    almost none of the overhead issues that a scope-based profiler has. Some
    sampling profilers are even designed to be run on long-running applications 
    for production monitoring.</p>
</li>
</ul>
<p>The most widely used tools are the following:</p>
<ul>
<li><a href="https://docs.python.org/3/library/profile.html#profile">cProfile</a> (Scope-Based): The python standard library profiler.</li>
<li><a href="https://github.com/vpelletier/pprofile">pprofile</a> (Scope-Based &amp; Sampling): A pure python profiler with optional 
    sampling.</li>
<li><a href="https://github.com/sumerc/yappi">yappi</a> (Scope-Based &amp; Sampling): A profiler (written in C) with multi-threading support.</li>
<li><a href="https://github.com/emeryberger/scalene">scalene</a> (Sampling): A profiler (written in C++) with built-in memory usage profiling.</li>
</ul>
<p>In general, it is recommended to start with <a href="https://docs.python.org/3/library/profile.html#profile">cProfile</a> and move on to other 
tools only if there is a need. Almost all use-cases are well-suited to the most 
basic scoped-based profiler and there are only infrequent times when more 
specialized profilers should be used. For example <a href="https://github.com/sumerc/yappi">yappi</a> may be well suited to 
testing a multi-threaded web server with extremely high traffic. Though 
sampling profilers can give extremely granular information, it is unlikely 
that the issues will not show up clearly in a scope-based profile.</p>
<h1 id="strategy">Strategy<a class="headerlink" href="#strategy" title="Permanent link">&para;</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>To follow along with the tutorial you must have <a href="https://www.jetbrains.com/pycharm/">PyCharm</a> <strong>Professional 
Edition</strong>. This tutorial makes extensive use of the <code>.pstat</code> profile viewer
which is not available in the Community Edition</p>
</div>
<p>In order to describe the process of profiling code, the following section will 
use cProfile and PyCharm to go through the steps of optimizing an unoptimized
function. The example function will compute a categorical embedding. The 
function implements mapping an occupation code to an embedding vector. In the 
example the occupation code will be a number within the range 
<code>(0, n_occupations)</code> and the embedding will have the shape 
<code>(n_occupations, n_components)</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Example Datasets</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<span class="n">n_occupations</span> <span class="o">=</span> <span class="mi">100000</span>  <span class="c1"># The number of possible occupation codes</span>
<span class="n">n_components</span> <span class="o">=</span> <span class="mi">100</span>      <span class="c1"># The number of components in the occupation embedding</span>
<span class="n">n_samples</span> <span class="o">=</span> <span class="mi">10000</span>       <span class="c1"># The number of users</span>


<span class="k">def</span> <span class="nf">user_dataframe</span><span class="p">():</span>
    <span class="n">example_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_occupations</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s2">&quot;occupation_code&quot;</span><span class="p">:</span> <span class="n">example_values</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="n">example_values</span><span class="p">,</span>
        <span class="s2">&quot;zip_code&quot;</span><span class="p">:</span> <span class="n">example_values</span><span class="p">,</span>
    <span class="p">})</span>


<span class="k">def</span> <span class="nf">occupation_code_embedding</span><span class="p">():</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_occupations</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n_occupations</span><span class="p">,</span> <span class="n">n_components</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Example Function Implementation</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">occupation_embedding_lookup</span><span class="p">(</span><span class="n">user_df</span><span class="p">,</span> <span class="n">embedding_df</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">embedding_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">user_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;occupation_code&quot;</span><span class="p">]</span>

        <span class="c1"># Check if the current occupation code is in the embedding index</span>
        <span class="k">if</span> <span class="n">embedding_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">value</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="c1"># Fetch the embedding for the given occupation code</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">embedding_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Select 0th (default) vector if occupation code is not found</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">embedding_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">vector</span>

    <span class="c1"># Concatenate all occupation embeddings for all users</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Main</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Build an example user data and embedding</span>
    <span class="n">user_df</span> <span class="o">=</span> <span class="n">user_dataframe</span><span class="p">()</span>
    <span class="n">embedding_df</span> <span class="o">=</span> <span class="n">occupation_code_embedding</span><span class="p">()</span>

    <span class="c1"># Compute the embedding from the user feature</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">occupation_embedding_lookup</span><span class="p">(</span><span class="n">user_df</span><span class="p">,</span> <span class="n">embedding_df</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<p>In the above example, the <code>occupation_embedding_lookup</code> will be the focus of
the profile. The <code>user_dataframe</code> and <code>occupation_code_embedding</code> functions
will show up in future profiles but should be ignored since they are only used 
to generate example datasets.</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>To demonstrate the importance of profiling, briefly look at the 
<code>occupation_embedding_lookup</code> function and come up with an guess for which
lines will have the worst performance problems.</p>
<p>What do you think will be the most time-consuming part of the function? </p>
<p>How long do you think it will take the function to run?</p>
</div>
<p>In pycharm, open the project, and file and then right click the within the 
editor panel. From the dropdown menu, select the <code>Profile '&lt;your_file&gt;'</code> option.
This will invoke <a href="https://docs.python.org/3/library/profile.html#profile">cProfile</a> on the file.</p>
<p><img alt="" src="../images/01-profile-menu.png" /></p>
<p>When the profile is complete, the PyCharm <code>.pstat</code> viewer will open the 
resulting profile. The results of any profiler that is capable of generating a 
<code>.pstat</code> file can be viewed in PyCharm (even if the profile was not generated
within PyCharm).</p>
<p><img alt="" src="../images/02-pstat-panel.png" /></p>
<p>On this <code>.pstat</code> viewer panel, the <code>Statistics</code> tab is selected by default.
Each row corresponds to a stack frame and its corresponding run time. This 
view can be useful, but it is hard to see exactly where bottleneck originated
from. Notice that the most time consuming call is <code>numpy.concatenate</code> which is 
never directly called in the code example above. This usually indicates that
this call is embedded in a library call.</p>
<p>The get a more informative view of the problem areas in the call-stack, select 
the <code>Call Graph</code> tab (outlined in red above).</p>
<p><img alt="" src="../images/03-call-graph.png" /></p>
<p>This view presents a much more direct representation of what takes the most 
time. When the call graph is first presented, it may be too small to read the
individual nodes. The zoom can be used by pressing the buttons on the top left 
of the panel (highlighted in red above).</p>
<p>Each node in the PyCharm <code>.pstat</code> viewer represents a different stack frame.
PyCharm color codes these stack frames from most time-consuming (red) to least
time-consuming (green). </p>
<p>Each stack frame tracks 3 things:</p>
<ul>
<li>Total time spent within the frame and all sub-frames (<code>Total</code>)</li>
<li>Total time spent within the frame but not within a sub-frame (<code>Own</code>)</li>
<li>Total number of times the frame was entered (<code>x&lt;number&gt;</code> in the top right)</li>
</ul>
<p>This is the information that should be used to guide where to optimize the 
code. The first areas of focus should be the red boxes. The bottom 3 stack 
frames are composed of:</p>
<ul>
<li><code>main.py</code> - The overall execution of the file. The <code>Total</code> will always equal
    the execution time of the program. In the example profile, the program took
    65.8 seconds to execute.</li>
<li><code>main</code> - This is the <code>def main()</code> function defined to drive the program.</li>
<li><code>occupation_embedding_lookup</code> - This is the function that performs the 
    embedding. In this view it becomes clear that the embedding computation 
    takes up nearly all of the execution time (99%). The remaining execution 
    time is spent in the initialization of data.</li>
</ul>
<p>None of this is very helpful since it is known that very little computation is
occuring outside of the embedding function. The next most time consuming 
portion of the code is the <code>__setitem__</code> call. Just from looking at the name, it
is not clear where this is occuring. PyCharm can directly show the source code
of the problem by right clicking on the node and selecting the "Navigate To
Source" option (highlighted in red above).</p>
<p>Upon inspecting the source code it becomes clear that this call is the 
<code>DataFrame.__setitem__</code> method. Further inspection of the profile call graph
chart reveals that this method calls into <code>DataFrame.append</code> which then calls
into <code>numpy.concatenate</code> (The most time consuming individual function).</p>
<p>There is only one place in the code where a DataFrame set item occurs in 
the <code>occupation_embedding_lookup</code> function:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">occupation_embedding_lookup</span><span class="p">(</span><span class="n">user_df</span><span class="p">,</span> <span class="n">embedding_df</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">embedding_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">user_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;occupation_code&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">embedding_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">value</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">embedding_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">embedding_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="hll">        <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">vector</span>
</span>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
<p>From the profile it becomes clear that every call to 
<code>result.loc[index] = vector</code> causes an array concatenation to be performed. This
means that a completely new array is allocated <em>every time</em> this line is 
executed. </p>
<p>To alleviate the issue, modify the function to collect the results in
a structure designed for concatenation. A python list is a good candidate for 
this since it is tuned to handle appending.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">occupation_embedding_lookup</span><span class="p">(</span><span class="n">user_df</span><span class="p">,</span> <span class="n">embedding_df</span><span class="p">):</span>
<span class="hll">    <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span>    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">user_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;occupation_code&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">embedding_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">value</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">embedding_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">embedding_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="hll">        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">user_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">embedding_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</span></code></pre></div>
<p>Run the profile on the updated function to view the results.</p>
<p><img alt="" src="../images/04-setitem-removal.png" /></p>
<p>The first thing to note is that the overall runtime has been drastically 
reduced. The original profile of 65.8 seconds has been reduced to 11.4 seconds.</p>
<p>The new profile now shows that the next most time consuming part of the 
function is the check to see if the value is in the index.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">occupation_embedding_lookup</span><span class="p">(</span><span class="n">user_df</span><span class="p">,</span> <span class="n">embedding_df</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">user_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;occupation_code&quot;</span><span class="p">]</span>
<span class="hll">        <span class="k">if</span> <span class="n">embedding_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">value</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span>            <span class="n">vector</span> <span class="o">=</span> <span class="n">embedding_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">embedding_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">user_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">embedding_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</code></pre></div>
<p>The line <code>embedding_df.index.isin([value]).any()</code> ends up checking to see if
each of the index values match the current occupation code. Rather than an 
<code>O(1)</code> hash lookup, this performs an <code>0(n)</code> search on the embedding index for 
every  single row in the <code>user_df</code>. This can be alleviated by simplifying the 
logic and using the <code>in</code> operator on the <code>pd.Index</code> object.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">occupation_embedding_lookup</span><span class="p">(</span><span class="n">user_df</span><span class="p">,</span> <span class="n">embedding_df</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">user_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;occupation_code&quot;</span><span class="p">]</span>
<span class="hll">        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">embedding_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
</span>            <span class="n">vector</span> <span class="o">=</span> <span class="n">embedding_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">embedding_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">user_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">embedding_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</code></pre></div>
<p>Run the profile on the updated function to view the results.</p>
<p><img alt="" src="../images/05-isin-removal.png" /></p>
<p>The final profile now shows that the overall execution time is 4.1 seconds. This
is a 16x speedup from the original profile!</p>
<p>Even though there may still be performance issues with this function, the code 
is already much more optimized than it was with just a few minor tweaks. </p>
<div class="admonition hint">
<p class="admonition-title">Challenge</p>
<p>Continue to profile the code and see if you can get a 1000x speedup!</p>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/felixgao/python-best-practices/" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 0c4.42 0 8 3.58 8 8a8.01 8.01 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27s-1.36.09-2 .27c-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>